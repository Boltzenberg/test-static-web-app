<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secret Santa Admin</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; }
    th { background: #eee; }
    button {
      padding: 8px 16px;
      background: #0067c5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover { background: #004f9e; }
    input[type=text], input[type=number] { width: 200px; }
    #authContainer { margin-top: 20px; }
    #eventEditor { border: 1px solid #ccc; padding: 15px; border-radius: 6px; }
  </style>
</head>

<body>

  <h1 id="pageTitle" style="display:none;">Secret Santa Admin</h1>

  <div id="authContainer"></div>

  <div id="editor" style="display:none;">

    <!-- CONFIG SECTION -->
    <h2>Config</h2>

    <button onclick="loadConfig()">Load Config</button>
    <button onclick="saveConfig()">Save Config</button>

    <h3>People</h3>
    <table id="peopleTable">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Remove</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addPerson()">Add Person</button>

    <h3>Restrictions</h3>
    <table id="restrictionsTable">
      <thead>
        <tr><th>Person 1 Email</th><th>Person 2 Email</th><th>Remove</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addRestriction()">Add Restriction</button>

    <!-- EVENTS SECTION -->
    <h2>Events</h2>

    <button onclick="showCreateEventPanel()">Create New Event</button>

    <div id="createEventPanel" style="display:none; margin-top:15px; border:1px solid #ccc; padding:10px; border-radius:6px;">
      <h3>Create New Event</h3>

      <label>
        Event Name (id):
        <input type="text" id="newEventId" placeholder="e.g., Family-2026" />
      </label>
      <br><br>

      <label>
        Group Name:
        <input type="text" id="newEventGroupName" placeholder="e.g., Family" />
      </label>
      <br><br>

      <label>
        Year:
        <input type="number" id="newEventYear" />
      </label>
      <br><br>

      <button onclick="createNewEvent()">Create Event</button>
      <button onclick="cancelCreateEventPanel()">Cancel</button>
    </div>

    <div id="eventsList"></div>

    <div id="eventEditor" style="display:none; margin-top:20px;">
      <h3 id="eventTitle"></h3>

      <div><strong>Group:</strong> <span id="eventGroupName"></span></div>
      <div><strong>Year:</strong> <span id="eventYear"></span></div>
      <div><strong>Is Running:</strong> <span id="eventIsRunningText"></span></div>

      <h4>Participants</h4>
      <div id="eventPeopleCheckboxes"></div>

      <button id="saveEventBtn" onclick="saveEvent()">Save Event</button>
      <button id="startEventBtn" onclick="startEvent()">Start Event</button>
    </div>

  </div>

  <script>
    let config = null;
    let events = [];
    let selectedEvent = null;

    // ---------------------------
    // AUTH
    // ---------------------------
    async function checkAuth() {
      const authDiv = document.getElementById('authContainer');

      try {
        const res = await fetch('/.auth/me');
        const data = await res.json();
        const user = data?.clientPrincipal;

        if (!user) {
          authDiv.innerHTML = `
            <p>You must sign in to manage Secret Santa.</p>
            <button id="signInBtn">Sign in with Microsoft</button>
          `;
          document.getElementById('signInBtn').onclick = () => {
            const returnUrl = encodeURIComponent(window.location.pathname);
            window.location.href = '/.auth/login/aad?post_login_redirect_uri=' + returnUrl;
          };
          return false;
        }

        authDiv.innerHTML = `
          <p>Signed in as <strong>${user.userDetails}</strong></p>
          <button id="signOutBtn">Sign out</button>
        `;
        document.getElementById('signOutBtn').onclick = () => {
          const returnUrl = encodeURIComponent(window.location.pathname);
          window.location.href = '/.auth/logout?post_logout_redirect_uri=' + returnUrl;
        };

        return true;

      } catch (err) {
        authDiv.textContent = "Error checking authentication.";
        console.error(err);
        return false;
      }
    }

    // ---------------------------
    // CONFIG
    // ---------------------------
    async function loadConfig() {
      const response = await fetch("/api/SecretSantaAdminGetConfig");
      config = await response.json();
      renderPeople();
      renderRestrictions();
    }

    function renderPeople() {
      const tbody = document.querySelector("#peopleTable tbody");
      tbody.innerHTML = "";

      config.People.forEach((p, index) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td><input type="text" value="${p.Name}" onchange="config.People[${index}].Name = this.value"></td>
          <td><input type="text" value="${p.Email}" onchange="config.People[${index}].Email = this.value"></td>
          <td><button onclick="removePerson(${index})">X</button></td>
        `;

        tbody.appendChild(row);
      });
    }

    function renderRestrictions() {
      const tbody = document.querySelector("#restrictionsTable tbody");
      tbody.innerHTML = "";

      config.Restrictions.forEach((r, index) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td><input type="text" value="${r.Person1Email}" onchange="config.Restrictions[${index}].Person1Email = this.value"></td>
          <td><input type="text" value="${r.Person2Email}" onchange="config.Restrictions[${index}].Person2Email = this.value"></td>
          <td><button onclick="removeRestriction(${index})">X</button></td>
        `;

        tbody.appendChild(row);
      });
    }

    function addPerson() {
      config.People.push({ Name: "", Email: "" });
      renderPeople();
    }

    function removePerson(index) {
      config.People.splice(index, 1);
      renderPeople();
    }

    function addRestriction() {
      config.Restrictions.push({ Person1Email: "", Person2Email: "" });
      renderRestrictions();
    }

    function removeRestriction(index) {
      config.Restrictions.splice(index, 1);
      renderRestrictions();
    }

    async function saveConfig() {
      const response = await fetch("/api/SecretSantaAdminUpdateConfig", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(config)
      });

      if (response.ok) {
        alert("Config saved!");
      } else {
        alert("Error saving config");
      }
    }

    // ---------------------------
    // EVENTS
    // ---------------------------
    async function loadEvents() {
      const response = await fetch("/api/SecretSantaGetAllEvents");
      events = await response.json();
      renderEventsList();
    }

    function renderEventsList() {
      const div = document.getElementById("eventsList");
      div.innerHTML = "";

      const groups = {};
      events.forEach(evt => {
        if (!groups[evt.GroupName]) groups[evt.GroupName] = [];
        groups[evt.GroupName].push(evt);
      });

      const groupNames = Object.keys(groups).sort();

      groupNames.forEach(groupName => {
        const header = document.createElement("h3");
        header.textContent = groupName;
        div.appendChild(header);

        const sorted = groups[groupName].sort((a, b) => b.Year - a.Year);

        sorted.forEach(evt => {
          const a = document.createElement("a");
          a.href = "";
          a.textContent = `${evt.Year} (${evt.id})`;
          a.style.display = "block";
          a.onclick = (e) => {
            e.preventDefault();
            showEventEditor(evt);
          };
          div.appendChild(a);
        });
      });
    }

    function showEventEditor(evt) {
      selectedEvent = evt;

      document.getElementById("eventTitle").textContent = evt.id;
      document.getElementById("eventGroupName").textContent = evt.GroupName;
      document.getElementById("eventYear").textContent = evt.Year;
      document.getElementById("eventIsRunningText").textContent = evt.IsRunning ? "Yes" : "No";

      const container = document.getElementById("eventPeopleCheckboxes");
      container.innerHTML = "";

      if (evt.IsRunning) {

        // Reveal All / Hide All toggle
        const toggle = document.createElement("button");
        toggle.textContent = "Reveal All";
        toggle.style.marginBottom = "10px";

        toggle.onclick = () => {
          const all = container.querySelectorAll(".assignmentReveal");
          const shouldShow = toggle.textContent === "Reveal All";

          all.forEach(div => {
            div.style.display = shouldShow ? "block" : "none";
          });

          toggle.textContent = shouldShow ? "Hide All" : "Reveal All";
        };

        container.appendChild(toggle);

        // Participant list with click‑to‑reveal
        evt.Participants.forEach(p => {
          const santa = p.SantaForEmail ?? "(unassigned)";

          const wrapper = document.createElement("div");
          wrapper.style.marginBottom = "6px";

          const link = document.createElement("a");
          link.href = "";
          link.textContent = `${p.Name} (${p.Email})`;
          link.style.cursor = "pointer";
          link.style.display = "inline-block";

          const reveal = document.createElement("div");
          reveal.textContent = `Santa For: ${santa}`;
          reveal.className = "assignmentReveal";
          reveal.style.marginLeft = "15px";
          reveal.style.display = "none";
          reveal.style.fontStyle = "italic";

          link.onclick = (e) => {
            e.preventDefault();
            reveal.style.display = reveal.style.display === "none" ? "block" : "none";
          };

          wrapper.appendChild(link);
          wrapper.appendChild(reveal);
          container.appendChild(wrapper);
        });

        document.getElementById("saveEventBtn").style.display = "none";
        document.getElementById("startEventBtn").style.display = "none";

      } else {

        config.People.forEach(person => {
          const id = `chk_${person.Email.replace(/[^a-zA-Z0-9]/g, "_")}`;
          const isInEvent = evt.Participants.some(p => p.Email === person.Email);

          const wrapper = document.createElement("div");
          wrapper.innerHTML = `
            <label>
              <input type="checkbox" id="${id}" ${isInEvent ? "checked" : ""}>
              ${person.Name} (${person.Email})
            </label>
          `;
          container.appendChild(wrapper);
        });

        document.getElementById("saveEventBtn").style.display = "inline-block";
        document.getElementById("startEventBtn").style.display = "inline-block";
      }

      document.getElementById("eventEditor").style.display = "block";
    }

    async function saveEvent() {
      if (!selectedEvent || selectedEvent.IsRunning) return;

      const updatedParticipants = [];

      config.People.forEach(person => {
        const id = `chk_${person.Email.replace(/[^a-zA-Z0-9]/g, "_")}`;
        const checkbox = document.getElementById(id);

        if (checkbox && checkbox.checked) {
          updatedParticipants.push({
            Name: person.Name,
            Email: person.Email,
            SantaForEmail: null
          });
        }
      });

      const updatedEvent = {
        id: selectedEvent.id,
        GroupName: selectedEvent.GroupName,
        Year: selectedEvent.Year,
        Participants: updatedParticipants
      };

      const response = await fetch("/api/SecretSantaAdminUpdateEvent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedEvent)
      });

      if (response.ok) {
        alert("Event updated!");
        await loadEvents();
      } else {
        alert("Error saving event");
      }
    }

    async function startEvent() {
      if (!selectedEvent) return;

      const response = await fetch("/api/SecretSantaAdminStartEvent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(selectedEvent)
      });

      if (response.ok) {
        alert("Event started! Assignments generated.");
        await loadEvents();
        showEventEditor(events.find(e => e.id === selectedEvent.id));
      } else {
        alert("Error starting event");
      }
    }

    // ---------------------------
    // CREATE NEW EVENT
    // ---------------------------
    function showCreateEventPanel() {
      document.getElementById("createEventPanel").style.display = "block";
      document.getElementById("newEventYear").value = new Date().getFullYear();
    }

    function cancelCreateEventPanel() {
      document.getElementById("createEventPanel").style.display = "none";
      document.getElementById("newEventId").value = "";
      document.getElementById("newEventGroupName").value = "";
      document.getElementById("newEventYear").value = "";
    }

    async function createNewEvent() {
      const id = document.getElementById("newEventId").value.trim();
      const groupName = document.getElementById("newEventGroupName").value.trim();
      const year = parseInt(document.getElementById("newEventYear").value);

      if (!id) {
        alert("Event Name (id) is required.");
        return;
      }
      if (!groupName) {
        alert("Group Name is required.");
        return;
      }
      if (!year || year < 1900 || year > 3000) {
        alert("Please enter a valid year.");
        return;
      }

      // Look for previous year's event
      const previous = events.find(e => e.GroupName === groupName && e.Year === year - 1);

      let participants = [];

      if (previous) {
        participants = previous.Participants.map(p => ({
          Name: p.Name,
          Email: p.Email,
          SantaForEmail: null
        }));
      }

      const newEvent = {
        id: id,
        GroupName: groupName,
        Year: year,
        Participants: participants
      };

      const response = await fetch("/api/SecretSantaAdminCreateEvent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newEvent)
      });

      if (!response.ok) {
        alert("Error creating event");
        return;
      }

      alert("Event created!");

      await loadEvents();

      const created = events.find(e => e.id === id);
      if (created) {
        showEventEditor(created);
      }

      cancelCreateEventPanel();
    }

    // ---------------------------
    // INIT
    // ---------------------------
    (async function init() {
      const isAuthed = await checkAuth();
      if (!isAuthed) return;

      document.getElementById('pageTitle').style.display = 'block';
      document.getElementById('editor').style.display = 'block';

      await loadConfig();
      await loadEvents();
    })();
  </script>

</body>
</html>
