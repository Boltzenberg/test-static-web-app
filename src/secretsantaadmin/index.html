<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secret Santa Admin</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; }
    th { background: #eee; }
    button {
      padding: 8px 16px;
      background: #0067c5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover { background: #004f9e; }
    input[type=text] { width: 200px; }
    #authContainer { margin-top: 20px; }
    #eventEditor { border: 1px solid #ccc; padding: 15px; border-radius: 6px; }
  </style>
</head>

<body>

  <h1 id="pageTitle" style="display:none;">Secret Santa Admin</h1>

  <div id="authContainer"></div>

  <div id="editor" style="display:none;">

    <!-- CONFIG SECTION -->
    <h2>Config</h2>

    <button onclick="loadConfig()">Load Config</button>
    <button onclick="saveConfig()">Save Config</button>

    <h3>People</h3>
    <table id="peopleTable">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Remove</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addPerson()">Add Person</button>

    <h3>Restrictions</h3>
    <table id="restrictionsTable">
      <thead>
        <tr><th>Person 1 Email</th><th>Person 2 Email</th><th>Remove</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addRestriction()">Add Restriction</button>

    <!-- EVENTS SECTION -->
    <h2>Events</h2>
    <div id="eventsList"></div>

    <div id="eventEditor" style="display:none; margin-top:20px;">
      <h3 id="eventTitle"></h3>

      <div><strong>Group:</strong> <span id="eventGroupName"></span></div>
      <div><strong>Year:</strong> <span id="eventYear"></span></div>
      <div><strong>Is Running:</strong> <span id="eventIsRunningText"></span></div>

      <h4>Participants</h4>
      <div id="eventPeopleCheckboxes"></div>

      <button id="saveEventBtn" onclick="saveEvent()">Save Event</button>
      <button id="startEventBtn" onclick="startEvent()">Start Event</button>
    </div>

  </div>

  <script>
    let config = null;
    let events = [];
    let selectedEvent = null;

    // ---------------------------
    // AUTH
    // ---------------------------
    async function checkAuth() {
      const authDiv = document.getElementById('authContainer');

      try {
        const res = await fetch('/.auth/me');
        const data = await res.json();
        const user = data?.clientPrincipal;

        if (!user) {
          authDiv.innerHTML = `
            <p>You must sign in to manage Secret Santa.</p>
            <button id="signInBtn">Sign in with Microsoft</button>
          `;
          document.getElementById('signInBtn').onclick = () => {
            const returnUrl = encodeURIComponent(window.location.pathname);
            window.location.href = '/.auth/login/aad?post_login_redirect_uri=' + returnUrl;
          };
          return false;
        }

        authDiv.innerHTML = `
          <p>Signed in as <strong>${user.userDetails}</strong></p>
          <button id="signOutBtn">Sign out</button>
        `;
        document.getElementById('signOutBtn').onclick = () => {
          const returnUrl = encodeURIComponent(window.location.pathname);
          window.location.href = '/.auth/logout?post_logout_redirect_uri=' + returnUrl;
        };

        return true;

      } catch (err) {
        authDiv.textContent = "Error checking authentication.";
        console.error(err);
        return false;
      }
    }

    // ---------------------------
    // CONFIG
    // ---------------------------
    async function loadConfig() {
      const response = await fetch("/api/SecretSantaAdminGetConfig");
      config = await response.json();
      renderPeople();
      renderRestrictions();
    }

    function renderPeople() {
      const tbody = document.querySelector("#peopleTable tbody");
      tbody.innerHTML = "";

      config.People.forEach((p, index) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td><input type="text" value="${p.Name}" onchange="config.People[${index}].Name = this.value"></td>
          <td><input type="text" value="${p.Email}" onchange="config.People[${index}].Email = this.value"></td>
          <td><button onclick="removePerson(${index})">X</button></td>
        `;

        tbody.appendChild(row);
      });
    }

    function renderRestrictions() {
      const tbody = document.querySelector("#restrictionsTable tbody");
      tbody.innerHTML = "";

      config.Restrictions.forEach((r, index) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td><input type="text" value="${r.Person1Email}" onchange="config.Restrictions[${index}].Person1Email = this.value"></td>
          <td><input type="text" value="${r.Person2Email}" onchange="config.Restrictions[${index}].Person2Email = this.value"></td>
          <td><button onclick="removeRestriction(${index})">X</button></td>
        `;

        tbody.appendChild(row);
      });
    }

    function addPerson() {
      config.People.push({ Name: "", Email: "" });
      renderPeople();
    }

    function removePerson(index) {
      config.People.splice(index, 1);
      renderPeople();
    }

    function addRestriction() {
      config.Restrictions.push({ Person1Email: "", Person2Email: "" });
      renderRestrictions();
    }

    function removeRestriction(index) {
      config.Restrictions.splice(index, 1);
      renderRestrictions();
    }

    async function saveConfig() {
      const response = await fetch("/api/SecretSantaAdminUpdateConfig", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(config)
      });

      if (response.ok) {
        alert("Config saved!");
      } else {
        alert("Error saving config");
      }
    }

    // ---------------------------
    // EVENTS
    // ---------------------------
    async function loadEvents() {
      const response = await fetch("/api/SecretSantaGetAllEvents");
      events = await response.json();
      renderEventsList();
    }

    function renderEventsList() {
      const div = document.getElementById("eventsList");
      div.innerHTML = "";

      events.forEach(evt => {
        const a = document.createElement("a");
        a.href = "#";
        a.textContent = `${evt.GroupName} ${evt.Year}`;
        a.style.display = "block";
        a.onclick = () => showEventEditor(evt);
        div.appendChild(a);
      });
    }

    function showEventEditor(evt) {
      selectedEvent = evt;

      document.getElementById("eventTitle").textContent = evt.id;
      document.getElementById("eventGroupName").textContent = evt.GroupName;
      document.getElementById("eventYear").textContent = evt.Year;
      document.getElementById("eventIsRunningText").textContent = evt.IsRunning ? "Yes" : "No";

      const container = document.getElementById("eventPeopleCheckboxes");
      container.innerHTML = "";

      const isRunning = evt.IsRunning;

      if (isRunning) {
        evt.Participants.forEach(p => {
          const santa = p.SantaForEmail ?? "(unassigned)";
          const div = document.createElement("div");
          div.textContent = `${p.Email} â†’ ${santa}`;
          container.appendChild(div);
        });

        document.getElementById("saveEventBtn").style.display = "none";
        document.getElementById("startEventBtn").style.display = "none";

      } else {
        config.People.forEach(person => {
          const id = `chk_${person.Email.replace(/[^a-zA-Z0-9]/g, "_")}`;
          const isInEvent = evt.Participants.some(p => p.Email === person.Email);

          const wrapper = document.createElement("div");
          wrapper.innerHTML = `
            <label>
              <input type="checkbox" id="${id}" ${isInEvent ? "checked" : ""}>
              ${person.Name} (${person.Email})
            </label>
          `;
          container.appendChild(wrapper);
        });

        document.getElementById("saveEventBtn").style.display = "inline-block";
        document.getElementById("startEventBtn").style.display = "inline-block";
      }

      document.getElementById("eventEditor").style.display = "block";
    }

    async function saveEvent() {
      if (!selectedEvent || selectedEvent.IsRunning) return;

      const updatedParticipants = [];

      config.People.forEach(person => {
        const id = `chk_${person.Email.replace(/[^a-zA-Z0-9]/g, "_")}`;
        const checkbox = document.getElementById(id);

        if (checkbox && checkbox.checked) {
          updatedParticipants.push({
            Email: person.Email,
            SantaForEmail: null
          });
        }
      });

      const updatedEvent = {
        id: selectedEvent.id,
        GroupName: selectedEvent.GroupName,
        Year: selectedEvent.Year,
        Participants: updatedParticipants
      };

      const response = await fetch("/api/SecretSantaAdminUpdateEvent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedEvent)
      });

      if (response.ok) {
        alert("Event updated!");
        await loadEvents();
      } else {
        alert("Error saving event");
      }
    }

    async function startEvent() {
      if (!selectedEvent) return;

      const response = await fetch("/api/SecretSantaAdminStartEvent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: selectedEvent.id })
      });

      if (response.ok) {
        alert("Event started! Assignments generated.");
        await loadEvents();
        showEventEditor(events.find(e => e.id === selectedEvent.id));
      } else {
        alert("Error starting event");
      }
    }

    // ---------------------------
    // INIT
    // ---------------------------
    (async function init() {
      const isAuthed = await checkAuth();
      if (!isAuthed) return;

      document.getElementById('pageTitle').style.display = 'block';
      document.getElementById('editor').style.display = 'block';

      await loadConfig();
      await loadEvents();
    })();
  </script>

</body>
</html>
