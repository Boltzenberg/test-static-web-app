<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secret Santa Admin</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; }
    th { background: #eee; }
    button {
      padding: 8px 16px;
      background: #0067c5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #004f9e; }
    input[type=text] { width: 200px; }
    #authContainer { margin-top: 20px; }
  </style>
</head>

<body>

  <h1 id="pageTitle" style="display:none;">Secret Santa Admin</h1>

  <div id="authContainer"></div>

  <div id="editor" style="display:none;">

    <button onclick="loadConfig()">Load Config</button>
    <button onclick="saveConfig()">Save Config</button>

    <h2>People</h2>
    <table id="peopleTable">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Remove</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addPerson()">Add Person</button>

    <h2>Restrictions</h2>
    <table id="restrictionsTable">
      <thead>
        <tr><th>Person 1 Email</th><th>Person 2 Email</th><th>Remove</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addRestriction()">Add Restriction</button>

  </div>

  <script>
    let config = null;

    async function checkAuth() {
      const authDiv = document.getElementById('authContainer');

      try {
        const res = await fetch('/.auth/me');
        const data = await res.json();
        const user = data?.clientPrincipal;

        if (!user) {
          authDiv.innerHTML = `
            <p>You must sign in to manage Secret Santa.</p>
            <button id="signInBtn">Sign in with Microsoft</button>
          `;
          document.getElementById('signInBtn').onclick = () => {
            const returnUrl = encodeURIComponent(window.location.pathname);
            window.location.href = '/.auth/login/aad?post_login_redirect_uri=' + returnUrl;
          };
          return false;
        }

        authDiv.innerHTML = `
          <p>Signed in as <strong>${user.userDetails}</strong></p>
          <button id="signOutBtn">Sign out</button>
        `;
        document.getElementById('signOutBtn').onclick = () => {
          const returnUrl = encodeURIComponent(window.location.pathname);
          window.location.href = '/.auth/logout?post_logout_redirect_uri=' + returnUrl;
        };

        return true;

      } catch (err) {
        authDiv.textContent = "Error checking authentication.";
        console.error(err);
        return false;
      }
    }

    async function loadConfig() {
      alert("Loading config");
      const response = await fetch("/api/SecretSantaAdminGetConfig");
      alert("Fetch done");
      config = await response.json();
      alert(JSON.stringify(config));
      renderPeople();
      renderRestrictions();
    }

    function renderPeople() {
      const tbody = document.querySelector("#peopleTable tbody");
      tbody.innerHTML = "";

      config.people.forEach((p, index) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td><input type="text" value="${p.name}" onchange="config.people[${index}].name = this.value"></td>
          <td><input type="text" value="${p.email}" onchange="config.people[${index}].email = this.value"></td>
          <td><button onclick="removePerson(${index})">X</button></td>
        `;

        tbody.appendChild(row);
      });
    }

    function renderRestrictions() {
      const tbody = document.querySelector("#restrictionsTable tbody");
      tbody.innerHTML = "";

      config.restrictions.forEach((r, index) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td><input type="text" value="${r.person1Email}" onchange="config.restrictions[${index}].person1Email = this.value"></td>
          <td><input type="text" value="${r.person2Email}" onchange="config.restrictions[${index}].person2Email = this.value"></td>
          <td><button onclick="removeRestriction(${index})">X</button></td>
        `;

        tbody.appendChild(row);
      });
    }

    function addPerson() {
      config.people.push({ name: "", email: "" });
      renderPeople();
    }

    function removePerson(index) {
      config.people.splice(index, 1);
      renderPeople();
    }

    function addRestriction() {
      config.restrictions.push({ person1Email: "", person2Email: "" });
      renderRestrictions();
    }

    function removeRestriction(index) {
      config.restrictions.splice(index, 1);
      renderRestrictions();
    }

    async function saveConfig() {
      alert("Saving config");
      alert(JSON.stringify(config));
      const response = await fetch("/api/SecretSantaAdminUpdateConfig", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(config)
      });

      if (response.ok) {
        alert("Config saved!");
      } else {
        alert("Error saving config");
      }
    }

    (async function init() {
      const isAuthed = await checkAuth();
      if (!isAuthed) return;

      document.getElementById('pageTitle').style.display = 'block';
      document.getElementById('editor').style.display = 'block';
    })();
  </script>

</body>
</html>
